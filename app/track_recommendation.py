
from __future__ import annotations

import json
from pathlib import Path
from typing import Dict, List

import numpy as np
import pandas as pd
import requests
from sklearn.cluster import KMeans
from sklearn.preprocessing import StandardScaler

JAVA_BASE_URL: str = "http://localhost:8080"

# --------------------------------------------------------------------
# 1) Java 서버에서 과목 목록 가져오기
# --------------------------------------------------------------------
def fetch_taken_list(user_id: int) -> List[str]:
    """
    Java Spring 서버:
        GET /users/{userId}/courses
        → [
            {"courseCode": "003278", "courseName": "컴퓨터구조"},
            ...
          ]
    중 courseName 만 리스트로 추출.
    """
    url = f"{JAVA_BASE_URL}/users/{user_id}/courses"
    resp = requests.get(url, timeout=5)
    resp.raise_for_status()        # 4xx/5xx 시 HTTPError 발생
    data = resp.json()
    return [item["courseName"] for item in data]


# --------------------------------------------------------------------
# 2) 트랙 정의 (필요-시 추가·수정)
# --------------------------------------------------------------------
track_courses: Dict[str, set[str]] = {
    "인공지능시스템": {
        "K-MOOC:모두를 위한 머신러닝", "K-MOOC:생성형 인공지능 입문", "인공지능",
        "패턴인식", "Human-AI Interaction", "HCI 개론", "지능형 정보검색", "정보검색", "인공지능시스템",
        "지능형앱프로그래밍", "강화학습", "자연어처리", "고성능인공지능프로그래밍",
        "딥러닝"
    },
    "메타버스플랫폼": {
        "K-MOOC:멀티미디어", "컴퓨터그래픽스", "디지털신호처리", "가상현실", "영상처리",
        "Human-AI Interaction", "HCI 개론", "웹기반시스템", "멀티코어프로그래밍",
        "컴퓨터비전", "컴퓨터비전시스템", "메타버스시스템", "메타버스데이터처리", "블록체인"
    },
    "클라우드컴퓨팅": {
        "웹프로그래밍", "문제해결및실습:JAVA", "운영체제", "데이터베이스",
        "컴퓨터네트워크", "리눅스프로그래밍및실습", "Unix프로그래밍", "웹기반시스템", "XML프로그래밍",
        "무선통신", "정보보호개론", "지능형네트워크프로그래밍", "네트워크프로그래밍", "AI 네트워킹"
    },
    "지능형에이전트": {
        "기계학습개론", "고급인공지능활용", "웹프로그래밍", "딥러닝실습", "파이썬기반딥러닝",
        "딥러닝개론", "시계열분석", "시계열분석및예측", "패턴인식", "자연어처리", "강화학습",
        "인공지능문제해결및실습"
    },
    "AI콘텐츠": {
        "기계학습개론", "인공지능수학1", "인공지능수학2", "디지털신호처리",
        "딥러닝실습", "파이썬기반딥러닝", "딥러닝개론", "영상처리", "컴퓨터그래픽스",
        "컴퓨터비전", "AR/VR /MR", "Human-AI Interaction", "HCI 개론"
    },
    "데이터인텔리전스": {
        "기계학습개론", "데이터분석개론", "딥러닝개론", "데이터베이스",
        "시계열분석", "시계열분석및예측", "딥러닝실습", "파이썬기반딥러닝", "데이터시각화", "설명가능한인공지능",
        "대용량데이터처리", "데이터문제해결및실습1", "데이터문제해결및실습2"
    }
}


# --------------------------------------------------------------------
# 3) 학습용 과거 학생 데이터 로드
# --------------------------------------------------------------------
def _load_students_data() -> Dict[str, List[str]]:
    """
    예시용 샘플 데이터.
    실제 운용 시 ⇒ DB나 CSV/JSON 파일로부터 불러오도록 변경하세요.
    """
    sample_path = Path(__file__).with_name("students_sample.json")
    if sample_path.exists():
        return json.loads(sample_path.read_text(encoding="utf-8"))


    return {
        'A': ["운영체제", "Technical Writing기초", "Capstone디자인(산학협력프로젝트)", "졸업연구및진로1", "인공지능과빅데이터", "컴퓨터네트워크", "신호및시스템", "세종사회봉사2", "어셈블리어", "대칭키암호론", "K-MOOC:정보보호와보안의기초", "동양의학(전통의학으로의여행)", "C#프로그래밍", "우리차문화의이해", "취창업과진로설계", "K-MOOC:모두를 위한 머신러닝", "기계학습개론", "K-MOOC:인공지능만들기:기계학습방법론의이해", "K-MOOC:UI디자인", "K-MOOC:삶과교육", "컴퓨터구조", "세계사:인간과문명", "알고리즘및실습", "이산수학및프로그래밍", "선형대수및프로그래밍", "English Reading Practice 1", "K-MOOC:코딩과스토리텔링", "교양으로읽는IT", "K-MOOC:고대그리스신화와문학세계", "K-MOOC:활쏘기", "K-MOOC:K-뷰티마케팅", "디지털시스템", "생명의미시적세계", "웹프로그래밍", "동양고전강독1", "자료구조및실습", "확률통계및프로그래밍", "수요집현강좌", "K-MOOC:콘텐츠산업의비즈니스전략", "공업수학1", "세종사회봉사1", "창업과기업가정신1", "서양철학:쟁점과토론", "고급C프로그래밍및실습", "공학설계기초(산학프로젝트입문)", "동서양고전문학강독", "English Listening Practice 1", "인간과우주", "일반물리학및실험1", "기초미적분학", "서양고전강독1", "문제해결을위한글쓰기와발표", "고급프로그래밍입문-P", "C프로그래밍및실습", "대학생활과진로설계"],
        'B': ["컴퓨터구조","컴퓨터그래픽스","데이터베이스프로그래밍","세종사회봉사1","사물인터넷","음성오디오처리","역사속의기독교","동양고전강독2","고급C프로그래밍및실습","알고리즘및실습","이산수학및프로그래밍","선형대수및프로그래밍","SW설계기초(산학프로젝트입문)","취창업과진로설계","운영체제","멀티미디어프로그래밍","C프로그래밍및실습","Technical Writing기초","확률통계및프로그래밍","English Reading","일반물리및시뮬레이션","English Reading Practice 1","공업수학1","기초미적분학","중국의정치경제와사회","창업과기업가정신1","서양고전강독3","세계사:인간과문명","유니스토리","일반생물학","통계학개론","서양철학:쟁점과토론","환경공학개론","고급프로그래밍입문-P","English Listening Practice 1","일반물리학및실험1","기초창의설계","문제해결을위한글쓰기와발표","소프트웨어기초코딩","대학생활과진로설계","저는주식투자가처음인데요"],
        'C': ["취창업과진로설계","공업수학2","동역학","웹프로그래밍","데이터문제해결및실습1","BA 데이터시각화","BA 소비자분석","공기역학","English Listening Practice 1","운영체제","데이터베이스","경영데이터관리","자료구조및실습","의사결정분석","BA 빅데이터통계분석론","BA 웹스크레이핑빅데이터분석","통계학개론","수치해석","세종사회봉사1","글로벌잉글리쉬2(심화)","비즈니스모델","공학설계기초(산학프로젝트입문)","알고리즘및실습","English Reading Practice 1","디자인씽킹","공업수학1","창업의이론과실제","확률통계및프로그래밍","창업기업의성장과재무","데이터분석개론","고급C프로그래밍및실습","서양철학:쟁점과토","대학생활과진로탐색","C프로그래밍및실습","일반물리학및실험1","문제해결을위한글쓰기와발표","고급프로그래밍입문-P","일변수미적분학","K-MOOC:일반인을위한물리코딩","신입생세미나"],
        'D': ["취창업과진로설계","운영체제","웹프로그래밍","데이터베이스","세종사회봉사1","고전특강","자료구조및실습","문제해결및실습:C++","K-MOOC:데이터베이스보안","컴퓨터네트워크","서양고전강독2","환경원격탐사","고급C프로그래밍및실습","알고리즘및실습","K-MOOC:모두를 위한 머신러닝","SW기초코딩","C프로그래밍및실습","환경화학","환경유체역학","하폐수처리및실습","환경단위공정기초","수처리시스템공학","공간정보개론","공업수학2","일반화학2","한국중세사","GIS및실습","환경바이오공학","English Reading Practice 1","공업수학1","일반화학1","수질관리","세계사:인간과문명","대기환경및기후변화","일반생물학","통계학개론","동양고전강독2","서양철학:쟁점과토론","환경공학개론","고급프로그래밍입문-P","English Listening Practice 1","일반물리학및실험1","기초미적분학","기초창의설계","문제해결을위한글쓰기와발표","대학생활과진로설계"],
        'F': ["음악감상스토리여행", "딥러닝개론", "취창업과진로설계", "기계학습", "데이터베이스", "미시경제학", "알고리즘및실습", "고급인공지능활용", "선형대수및프로그래밍", "알고리즘및실습", "창업과기업가정신1", "수치해석", "컴퓨터구조", "인공지능과빅데이터", "진로오딧세이", "데이터분석개론", "확률통계및프로그래밍", "자료구조및실습", "세종사회봉사1", "웹프로그래밍", "고급C프로그래밍및실습", "공업수학1", "대학영어", "신입생세미나B", "공학설계기초(산학프로젝트입문)", "서양철학:쟁점과토론", "세종사회봉사1", "통계학개론", "고급프로그래밍활용", "일반물리학1", "신입생세미나A", "우주자연인간", "문제해결을위한글쓰기와발표", "미적분학1"],
        'G': ["융합예술의이해", "취창업과진로설계", "K-MOOC:코딩과스토리텔링", "K-MOOC:콘텐츠산업의비즈니스전략", "K-MOOC:웨어러블컴퓨터디자인", "기계학습", "데이터베이스", "고급인공지능활용", "선형대수및프로그래밍", "알고리즘및실습", "수치해석", "컴퓨터구조", "인공지능과빅데이터", "경제학", "데이터분석개론", "확률통계및프로그래밍", "자료구조및실습", "C프로그래밍및실습", "C프로그래밍및실습", "우주자연인간", "신입생세미나B", "공업수학1", "대학영어", "우주자연인간", "K-MOOC:웨어러블컴퓨터디자인", "공학설계기초(산학프로젝트입문)", "서양철학:쟁점과토론", "통계학개론", "고급프로그래밍활용", "일반물리학1", "신입생세미나A", "우주자연인간", "문제해결을위한글쓰기와발표", "미적분학1"],
        'H': ["의사결정분석", "기계학습", "C프로그래밍및실습", "데이터베이스", "수리통계학1", "회귀분석1", "컴퓨터네트워크", "인공지능과빅데이터", "경영학", "선형대수및프로그래밍", "수치해석", "컴퓨터구조", "선형대수학2", "계산수학1", "확률통계및프로그래밍", "선형대수학1", "해석학개론1", "전산통계실습", "미적분학1", "우주자연인간", "신입생세미나B", "고급프로그래밍활용", "우주자연인간", "K-MOOC:웨어러블컴퓨터디자인", "문제해결을위한글쓰기와발표", "통계학2", "미적분학2", "SW기초코딩", "K-MOOC:코딩과스토리텔링", "대학영어", "신입생세미나A", "서양철학:쟁점과토론", "창업과기업가정신1", "통계학1", "미적분학1"],
        'I': ["K-MOOC:생성형인공지능입문", "K-MOOC:웨어러블컴퓨터디자인", "수요집현강좌", "졸업연구및진로1", "기계학습", "Capstone디자인(산학협력프로젝트)", "데이터베이스", "알고리즘및실습", "취창업과진로설계", "English Listening Practice 1", "데이터문제해결및실습1", "데이터시각화", "English Reading", "오픈소스SW개론", "알고리즘및실습", "인공지능", "운영체제", "English Reading Practice 1", "데이터분석개론", "서양고전강독1", "기계학습", "자료구조및실습", "Technical Writing기초", "서양고전강독1", "데이터베이스", "운영체제", "동양고전강독2", "선형대수및프로그래밍", "고급C프로그래밍및실습", "세계사:인간과문명", "동양고전강독2", "과학기술과사회", "세종리더십", "수치해석", "컴퓨터구조", "C프로그래밍및실습", "생명과학의미래", "확률통계및프로그래밍", "서양고전강독3", "창업과기업가정신1", "영어듣기연습", "웹프로그래밍", "과학사"],
        'J': ["알기쉬운코딩", "한국의문화와한류", "K-MOOC:코딩과스토리텔링", "K-MOOC:콘텐츠산업의비즈니스전략", "기계학습", "무선통신", "문제해결및실습:JAVA", "공학설계기초(산학프로젝트입문)", "고전특강", "Capstone디자인(산학협력프로젝트)", "문제해결및실습:JAVA", "컴퓨터네트워크", "K-MOOC:생성형인공지능입문", "지속가능발전목표(SDGs)의이해와실천", "취창업과진로설계", "확률통계및프로그래밍", "Technical Writing기초", "공간마케팅", "영상처리", "데이터베이스", "세계사:인간과문명", "C#프로그래밍", "성과문화", "운영체제", "컴퓨터그래픽스"],
        'K': ["데이터분석개론", "인공지능활용", "기계학습개론", "취창업과진로설계", "의사결정분석", "기계학습", "데이터베이스", "통계학개론", "선형대수및프로그래밍", "알고리즘및실습", "고급C프로그래밍및실습", "수치해석", "컴퓨터구조", "공업수학1", "데이터분석개론", "확률통계및프로그래밍", "자료구조및실습", "C프로그래밍및실습", "세계사:인간과문명", "웹프로그래밍"],
        'L': ["인공지능활용", "경제학", "딥러닝개론", "취창업과진로설계", "자연어처리", "K-MOOC:일반인을위한물리코딩", "기계학습", "동양고전강독1", "데이터베이스", "고급인공지능활용", "파이썬기반기계학습", "인공지능수학2", "알고리즘및실습", "디지털신호처리", "컴퓨터구조", "인공지능과빅데이터", "기계학습개론", "인공지능수학1", "확률통계및프로그래밍", "자료구조및실습", "창업과기업가정신1", "세종사회봉사1", "웹프로그래밍", "대학영어", "신입생세미나B", "K-MOOC:코딩과스토리텔링", "이산수학및프로그래밍", "공학설계기초(산학프로젝트입문)", "고급C프로그래밍및실습", "서양철학:쟁점과토론", "공업수학1", "신입생세미나A", "고급프로그래밍활용", "기초미적분학", "일반물리학1", "우주자연인간", "문제해결을위한글쓰기와발표"],
        'M': ["경제학", "자기주도창의전공Ⅰ", "기계학습", "데이터베이스", "통계학개론", "알고리즘및실습", "고급인공지능활용", "융합예술의이해", "선형대수및프로그래밍", "확률통계및프로그래밍", "세종사회봉사1", "채플2", "수치해석", "컴퓨터구조", "인공지능과빅데이터", "현대예술의이해", "데이터분석개론", "자료구조및실습", "웹프로그래밍", "생명의미시적세계", "고급C프로그래밍및실습", "공업수학1", "대학영어", "신입생세미나B", "공학설계기초(산학프로젝트입문)", "서양철학:쟁점과토론", "통계학개론", "신입생세미나A", "고급프로그래밍활용", "일반물리학1", "우주자연인간", "문제해결을위한글쓰기와발표", "채플1", "미적분학1"],
        'O':["세계사:인간과문명", "지능사물인터넷개론", "기계학습", "동서양고전문학강독", "Technical Writing기초", "데이터베이스", "선형대수및프로그래밍", "알고리즘및실습", "동서양고전문학강독", "고급C프로그래밍및실습", "수치해석", "컴퓨터구조", "데이터분석기술의이해", "곤충의새로운가치", "인공지능과빅데이터", "확률통계및프로그래밍", "자료구조및실습", "생명과학의미래"],
        'P': ["K-MOOC:모두를위한머신러닝", "동서양의사상과윤리", "자료구조및실습", "확률및통계", "웹프로그래밍", "디지털시스템", "K-MOOC:웨어러블컴퓨터디자인", "대학영어", "세종인을위한전공탐색", "인공지능과빅데이터", "고급C프로그래밍및실습", "서양철학:쟁점과토론", "선형대수", "공업수학1", "세종인을위한진로설계", "우주자연인간", "우주자연인간", "우주자연인간", "미생물의세계", "우주자연인간", "C프로그래밍및실습", "문제해결을위한글쓰기와발표", "확률및통계", "미적분학1"],
        'Q': ["이미지메이킹과매너", "세계사", "K-MOOC:모두를위한머신러닝", "공학설계기초(산학프로젝트입문)", "경영학", "자료구조및실습", "창업과기업가정신1", "디지털시스템", "세종인을위한전공탐색", "인공지능과빅데이터", "대학영어", "고급C프로그래밍및실습", "서양철학:쟁점과토론", "선형대수", "공업수학1", "세종인을위한진로설계", "우주자연인간", "미적분학1", "고급프로그래밍활용", "우주자연인간", "C프로그래밍및실습", "문제해결을위한글쓰기와발표", "확률및통계"],
        'R': ["K-MOOC:모두를위한머신러닝", "공학설계기초(산학프로젝트입문)", "K-MOOC:데이터베이스보안", "자료구조및실습", "웹프로그래밍", "디지털시스템", "세종인을위한전공탐색", "인공지능과빅데이터", "대학영어", "고급C프로그래밍및실습", "서양철학:쟁점과토론", "서양고전강독2", "선형대수", "공업수학1", "세종인을위한진로설계", "우주자연인간", "우주자연인간", "우주자연인간", "동서양고전문학강독", "동서양고전문학강독", "동서양고전문학강독", "고급프로그래밍활용", "우주자연인간", "C프로그래밍및실습", "문제해결을위한글쓰기와발표", "확률및통계", "미적분학1"],
        'S': ["K-MOOC:모두를위한머신러닝", "공학설계기초(산학프로젝트입문)", "K-MOOC:웨어러블컴퓨터디자인", "자료구조및실습", "세종사회봉사1", "웹프로그래밍", "디지털시스템", "공업수학1", "세종인을위한전공탐색", "인공지능과빅데이터", "대학영어", "K-MOOC:정보보호와보안의기초", "고급C프로그래밍및실습", "서양철학:쟁점과토론", "선형대수", "세종인을위한진로설계", "우주자연인간", "고급프로그래밍활용", "우주자연인간", "C프로그래밍및실습", "문제해결을위한글쓰기와발표", "확률및통계", "미적분학1"],
        'T': ["K-MOOC:생성형인공지능입문", "K-MOOC:모두를위한머신러닝", "자료구조및실습", "확률및통계", "디지털시스템", "K-MOOC:멀티미디어", "이산수학및프로그래밍", "고급C프로그래밍및실습", "디지털신호처리", "컴퓨터구조", "선형대수", "C프로그래밍및실습", "생활일본어", "확률통계및프로그래밍", "신호및시스템", "미적분학1"],
        'U': ["자료구조및실습", "공간과인간:인문,예술,공학의융합", "운영체제", "디지털시스템", "컴퓨터그래픽스", "세종인을위한전공탐색", "English Reading", "선형대수및프로그래밍", "문제해결및실습:JAVA", "이산수학및프로그래밍", "동양종교의이해", "컴퓨터구조", "인공지능과빅데이터", "융합예술의이해", "동서양의사상과윤리", "확률통계및프로그래밍", "고급C프로그래밍및실습", "디지털시스템"],
        'V': ["K-MOOC:생성형인공지능입문", "K-MOOC:모두를위한머신러닝", "문제해결및실습:C++", "자료구조및실습", "공학설계기초(산학프로젝트입문)", "웹프로그래밍", "디지털시스템", "알고리즘및실습", "세종인을위한전공탐색", "세계사", "대학영어", "알고리즘및실습", "고급C프로그래밍및실습", "서양철학:쟁점과토론", "선형대수", "공업수학1", "세종인을위한진로설계", "우주자연인간", "고급프로그래밍활용", "우주자연인간", "C프로그래밍및실습", "문제해결을위한글쓰기와발표", "확률및통계", "미적분학1"],
        'W': ["자료구조및실습", "K-MOOC:모두를위한머신러닝", "공학설계기초(산학프로젝트입문)", "자료구조및실습", "확률및통계", "웹프로그래밍", "디지털시스템", "동서양고전문학강독", "서양고전강독1"],
        'X': ["K-MOOC:생성형인공지능입문", "신호및시스템", "미디어빅뱅과방송", "자료구조및실습", "데이터베이스", "운영체제", "디지털시스템", "동서양의사상과윤리", "K-MOOC:멀티미디어", "취창업과진로설계", "문제해결및실습:JAVA", "공학설계기초(산학프로젝트입문)", "고급C프로그래밍및실습", "창업과기업가정신1", "공업수학1", "일반물리학1", "기초미적분학", "고급프로그래밍활용", "K-MOOC:모두를위한머신러닝", "확률통계및프로그래밍", "C프로그래밍및실습", "인공지능과빅데이터", "진로상담의이해와실제", "일반생물학1", "교육철학의이해", "일반미생물학및실험"],
        'Y': ["과학사", "서양고전강독3", "K-MOOC:모두를위한머신러닝", "인공지능과빅데이터", "자료구조및실습", "동서양고전문학강독", "서양고전강독3", "웹프로그래밍", "과학사", "디지털시스템", "알고리즘및실습", "K-MOOC:멀티미디어", "선형대수및프로그래밍", "문제해결및실습:JAVA", "이산수학및프로그래밍", "알고리즘및실습", "컴퓨터구조", "나에게꼭필요한심리학", "서양고전강독4", "서양고전강독4"],
        'Z': ["자료구조및실습", "K-MOOC:생성형인공지능입문", "K-MOOC:모두를위한머신러닝", "세계사:인간과문명", "K-MOOC:데이터베이스보안", "자료구조및실습", "창업과기업가정신1", "확률및통계", "디지털시스템", "서양고전강독3"]
    }


students_data = _load_students_data()

# 학생 × 과목 0/1 매트릭스 생성
all_courses: List[str] = sorted({c for lst in students_data.values() for c in lst})
df_feat = pd.DataFrame(
    {sid: [1 if c in lst else 0 for c in all_courses] for sid, lst in students_data.items()}
).T
df_feat.columns = all_courses

# 스케일링 + K-Means 학습 (클러스터 수는 최소 3개 또는 학생 수)
scaler = StandardScaler().fit(df_feat)
scaled = scaler.transform(df_feat)
n_clusters = min(3, df_feat.shape[0])
kmeans = KMeans(n_clusters=n_clusters, random_state=42, n_init=10).fit(scaled)

# 클러스터별 트랙 점수 평균(프로파일)
raw_scores_df = df_feat.apply(
    lambda row: pd.Series(
        {t: len(set(students_data[row.name]) & req) / len(req) for t, req in track_courses.items()}
    ),
    axis=1,
)
raw_scores_df["cluster"] = kmeans.labels_
profiles_df = raw_scores_df.groupby("cluster").mean()


# --------------------------------------------------------------------
# 4) 외부 공개 함수: recommend_for_user
# --------------------------------------------------------------------
def recommend_for_user(user_id: int) -> Dict:
    """
    지정한 user_id 에 대해
    {
      rawScores:      {트랙: 점수},
      probabilities:  {트랙: 확률},
      assignedCluster: k,
      clusterProfile: {트랙: 평균점수}
    }
    형태의 JSON-serializable 딕셔너리를 반환.
    """
    # 4-1) Java 서버 호출 → 수강 과목
    taken = fetch_taken_list(user_id)

    # 4-2) 트랙별 raw 점수 & 확률
    raw = {t: len(set(taken) & req) / len(req) for t, req in track_courses.items()}
    total = sum(raw.values())
    probs = {t: (raw[t] / total) if total else 0 for t in raw}

    # 4-3) K-Means 로 클러스터 할당
    x = np.array([1 if c in taken else 0 for c in all_courses]).reshape(1, -1)
    x_scaled = scaler.transform(x)
    cluster_id = int(kmeans.predict(x_scaled)[0])

    # 4-4) 클러스터 프로파일
    profile = profiles_df.loc[cluster_id].to_dict()

    return {
        "rawScores": raw,
        "probabilities": probs,
        "assignedCluster": cluster_id,
        "clusterProfile": profile,
    }
